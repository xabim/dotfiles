#!/usr/bin/env bash
set -euo pipefail

# ytcast: SMB mount -> download new audio -> rotate -> prune archive -> generate RSS feeds -> serve locally
#
# Requirements:
#   - yt-dlp (recent)
#   - ffmpeg
#   - python3
#   - cifs-utils (mount.cifs)
#
# Config file:
#   ~/.config/ytcast/channels.json
#
# Env overrides:
#   YTCAST_MOUNT_NAS (default: /music)
#   YTCAST_NAS_IP (default: 192.168.1.100)
#   YTCAST_NAS_SHARE (default: music)
#   YTCAST_SMB_VERS (default: 3.0)
#   YTCAST_SMB_USER (default: xabim)
#   YTCAST_SUBDIR (default: yt-podcasts)
#   YTCAST_PORT (default: 8000)
#   YTCAST_KEEP_PER_CHANNEL (default: 60)
#   YTCAST_AUDIO_FORMAT (default: opus)
#   YTCAST_AUDIO_QUALITY (default: 64K)
#   YTCAST_MAX_ITEMS_PER_FEED (default: 200)

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/ytcast"
PY_DIR="$HOME/.local/lib/ytcast"
CHANNELS_JSON="$CONFIG_DIR/channels.json"

PORT="${YTCAST_PORT:-8000}"
KEEP_PER_CHANNEL="${YTCAST_KEEP_PER_CHANNEL:-60}"
AUDIO_FORMAT="${YTCAST_AUDIO_FORMAT:-opus}"
AUDIO_QUALITY="${YTCAST_AUDIO_QUALITY:-64K}"
MAX_ITEMS_PER_FEED="${YTCAST_MAX_ITEMS_PER_FEED:-200}"

SMB_USER="${YTCAST_SMB_USER:-xabim}"

# SMB mount options (embedded)
MOUNT_NAS="${YTCAST_MOUNT_NAS:-/music}"
NAS_IP="${YTCAST_NAS_IP:-192.168.1.100}"
NAS_SHARE="${YTCAST_NAS_SHARE:-music}"
SMB_VERS="${YTCAST_SMB_VERS:-3.0}"

SUBDIR="${YTCAST_SUBDIR:-yt-podcasts}"
UNC="//$NAS_IP/$NAS_SHARE"
BASE_DIR="$MOUNT_NAS/$SUBDIR"
AUDIO_DIR="$BASE_DIR/audio"
FEEDS_DIR="$BASE_DIR/feeds"
ARCHIVE_DIR="$BASE_DIR/archive"
STATE_FILE="$BASE_DIR/state.tsv"

DID_MOUNT=0

need_cmd() { command -v "$1" >/dev/null 2>&1 || { echo "ERROR: falta '$1'"; exit 1; }; }

need_cmd yt-dlp
need_cmd ffmpeg
need_cmd python3
need_cmd mount
need_cmd mountpoint
need_cmd sudo

for f in download.py rotate_global.py prune_state.py gen_feeds.py serve.py; do
  if [[ ! -f "$PY_DIR/$f" ]]; then
    echo "ERROR: falta $PY_DIR/$f"
    exit 1
  fi
done

if [[ ! -f "$CHANNELS_JSON" ]]; then
  echo "ERROR: falta $CHANNELS_JSON"
  exit 1
fi

prompt_smb_password() {
  if [[ -z "${SMB_PASSWORD:-}" ]]; then
    read -r -s -p "SMB password for user '$SMB_USER': " SMB_PASSWORD
    echo
  fi
}

cleanup_on_exit() {
  trap - EXIT INT TERM
  local m="${MOUNT_NAS:-}"
  if [[ "${DID_MOUNT:-0}" -eq 1 ]] && [[ -n "$m" ]] && mountpoint -q "$m"; then
    echo "==> Unmount automático: $m"
    sudo umount "$m" || true
  fi
}

mount_smb_if_needed() {
  if mountpoint -q "$MOUNT_NAS"; then
    return 0
  fi

  echo "==> Montando SMB en $MOUNT_NAS"
  sudo mkdir -p "$MOUNT_NAS"

  prompt_smb_password

  sudo mount -t cifs "$UNC" "$MOUNT_NAS" \
    -o "username=${SMB_USER},password=${SMB_PASSWORD},vers=${SMB_VERS},iocharset=utf8,uid=$(id -u),gid=$(id -g),noperm,soft"

  DID_MOUNT=1
}

prepare_dirs() {
  mkdir -p "$BASE_DIR" "$AUDIO_DIR" "$FEEDS_DIR" "$ARCHIVE_DIR"
  touch "$STATE_FILE"
}

main() {
  mount_smb_if_needed
  prepare_dirs

  echo "==> Descargando audio (solo nuevos) a $AUDIO_DIR"
  python3 "$PY_DIR/download.py" \
    --channels "$CHANNELS_JSON" \
    --audio-dir "$AUDIO_DIR" \
    --archive-dir "$ARCHIVE_DIR" \
    --state "$STATE_FILE" \
    --audio-format "$AUDIO_FORMAT" \
    --audio-quality "$AUDIO_QUALITY"

  echo "==> Rotación GLOBAL: mantener últimos $KEEP_PER_CHANNEL por canal"
  python3 "$PY_DIR/rotate_global.py" --audio-dir "$AUDIO_DIR" --keep "$KEEP_PER_CHANNEL"

  echo "==> Limpieza de state.tsv y archivos de archive (alineada con rotación)"
  python3 "$PY_DIR/prune_state.py" --state "$STATE_FILE" --archive-dir "$ARCHIVE_DIR"

  echo "==> Generando feeds (1 por canal slug) en $FEEDS_DIR"
  python3 "$PY_DIR/gen_feeds.py" \
    --channels "$CHANNELS_JSON" \
    --base-dir "$BASE_DIR" \
    --audio-dir "$AUDIO_DIR" \
    --feeds-dir "$FEEDS_DIR" \
    --port "$PORT" \
    --max-items "$MAX_ITEMS_PER_FEED"

  echo "==> Servidor web local (CTRL+C para parar)"
  python3 "$PY_DIR/serve.py" --dir "$BASE_DIR" --port "$PORT"
}

main "$@"
