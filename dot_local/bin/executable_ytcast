#!/usr/bin/env bash
set -euo pipefail

# ytcast: SMB (Synology) + yt-dlp audio + per-channel RSS (por carpeta) + servidor web local
# Usage: ytcast
#
# Env overrides:
#   YTCAST_MOUNT_NAS, YTCAST_NAS_IP, YTCAST_NAS_SHARE, YTCAST_SMB_VERS
#   YTCAST_SMB_USER (default: xabim)
#   YTCAST_PORT (default: 8000)
#   YTCAST_KEEP_PER_CHANNEL (default: 60)   # GLOBAL para todos
#   YTCAST_AUDIO_FORMAT (default: opus)
#   YTCAST_AUDIO_QUALITY (default: 64K)
#   YTCAST_MAX_ITEMS_PER_FEED (default: 200)

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/ytcast"
PY_DIR="$HOME/.local/lib/ytcast"

CHANNELS_JSON="$CONFIG_DIR/channels.json"

PORT="${YTCAST_PORT:-8000}"
KEEP_PER_CHANNEL="${YTCAST_KEEP_PER_CHANNEL:-60}"
AUDIO_FORMAT="${YTCAST_AUDIO_FORMAT:-opus}"
AUDIO_QUALITY="${YTCAST_AUDIO_QUALITY:-64K}"
MAX_ITEMS_PER_FEED="${YTCAST_MAX_ITEMS_PER_FEED:-200}"

SMB_USER="${YTCAST_SMB_USER:-xabim}"

# SMB mount options (embedded)
MOUNT_NAS="${YTCAST_MOUNT_NAS:-/music}"
NAS_IP="${YTCAST_NAS_IP:-192.168.1.100}"
NAS_SHARE="${YTCAST_NAS_SHARE:-music}"
SMB_VERS="${YTCAST_SMB_VERS:-3.0}"

# Data layout on NAS
SUBDIR="${YTCAST_SUBDIR:-youtube-audio}"
UNC="//$NAS_IP/$NAS_SHARE"
BASE_DIR="$MOUNT_NAS/$SUBDIR"
AUDIO_DIR="$BASE_DIR/audio"
FEEDS_DIR="$BASE_DIR/feeds"
ARCHIVE_FILE="$BASE_DIR/archive.txt"
STATE_FILE="$BASE_DIR/state.tsv"
CHANNEL_MAP_JSON="$BASE_DIR/channel_map.json"
CHANNEL_URLS_TXT="$BASE_DIR/channels_urls.txt"

DID_MOUNT=0

need_cmd() { command -v "$1" >/dev/null 2>&1 || { echo "ERROR: falta '$1'"; exit 1; }; }

need_cmd yt-dlp
need_cmd ffmpeg
need_cmd python3
need_cmd mount
need_cmd mountpoint
need_cmd sudo

if [[ ! -f "$CHANNELS_JSON" ]]; then
  echo "ERROR: falta $CHANNELS_JSON"
  exit 1
fi

for f in channels_to_urls.py channels_map.py rotate_global.py gen_feeds.py serve.py prune_state.py; do
  if [[ ! -f "$PY_DIR/$f" ]]; then
    echo "ERROR: falta $PY_DIR/$f"
    exit 1
  fi
done

prompt_smb_password() {
  if [[ -z "${SMB_PASSWORD:-}" ]]; then
    read -r -s -p "SMB password for user '$SMB_USER': " SMB_PASSWORD
    echo
  fi
}

cleanup_on_exit() {
  if [[ "$DID_MOUNT" -eq 1 ]]; then
    echo "==> Unmount automático: $MOUNT_NAS"
    sudo umount "$MOUNT_NAS" || true
  fi
}
trap cleanup_on_exit EXIT INT TERM

mount_smb_if_needed() {
  if mountpoint -q "$MOUNT_NAS"; then
    return 0
  fi

  echo "==> Montando SMB en $MOUNT_NAS"
  sudo mkdir -p "$MOUNT_NAS"

  prompt_smb_password

  sudo mount -t cifs "$UNC" "$MOUNT_NAS" \
    -o "username=${SMB_USER},password=${SMB_PASSWORD},vers=${SMB_VERS},iocharset=utf8,uid=$(id -u),gid=$(id -g),noperm,soft"

  DID_MOUNT=1
}

prepare_dirs() {
  mkdir -p "$CONFIG_DIR"
  mkdir -p "$AUDIO_DIR" "$FEEDS_DIR"
  touch "$ARCHIVE_FILE" "$STATE_FILE"
}

build_channel_files() {
  echo "==> Preparando URLs y mapping desde channels.json"
  python3 "$PY_DIR/channels_to_urls.py" --in "$CHANNELS_JSON" --out "$CHANNEL_URLS_TXT"
  python3 "$PY_DIR/channels_map.py" --in "$CHANNELS_JSON" --out "$CHANNEL_MAP_JSON"
}

download_audio() {
  echo "==> Descargando audio (solo nuevos) a $AUDIO_DIR"
  yt-dlp \
    --no-progress \
    --yes-playlist \
    --ignore-errors \
    --download-archive "$ARCHIVE_FILE" \
    --extract-audio \
    --audio-format "$AUDIO_FORMAT" \
    --audio-quality "$AUDIO_QUALITY" \
    --embed-metadata \
    --embed-thumbnail \
    --add-metadata \
    --exec after_move:"bash -c 'printf \"%s\t%s\n\" \"%(id)s\" \"%(filepath)s\" >> \"${STATE_FILE}\"'" \
    -o "$AUDIO_DIR/%(channel)s/%(upload_date)s - %(title)s.%(ext)s" \
    -a "$CHANNEL_URLS_TXT"
}

rotate_global() {
  echo "==> Rotación GLOBAL: mantener últimos $KEEP_PER_CHANNEL por canal (todas las carpetas por igual)"
  python3 "$PY_DIR/rotate_global.py" --audio-dir "$AUDIO_DIR" --keep "$KEEP_PER_CHANNEL"
}

prune_state_and_archive() {
  echo "==> Limpieza de state.tsv y archive.txt (alineada con rotación)"
  python3 "$PY_DIR/prune_state.py" --state "$STATE_FILE" --archive "$ARCHIVE_FILE"
}

generate_feeds() {
  echo "==> Generando feeds (1 por carpeta) en $FEEDS_DIR"
  python3 "$PY_DIR/gen_feeds.py" \
    --base-dir "$BASE_DIR" \
    --audio-dir "$AUDIO_DIR" \
    --feeds-dir "$FEEDS_DIR" \
    --channel-map "$CHANNEL_MAP_JSON" \
    --port "$PORT" \
    --max-items "$MAX_ITEMS_PER_FEED"
}

serve() {
  echo "==> Servidor web local (CTRL+C para parar)"
  python3 "$PY_DIR/serve.py" --dir "$BASE_DIR" --port "$PORT"
}

main() {
  mount_smb_if_needed
  mkdir -p "$BASE_DIR"
  prepare_dirs
  build_channel_files
  download_audio
  rotate_global
  prune_state_and_archive
  generate_feeds
  serve
}

main "$@"
