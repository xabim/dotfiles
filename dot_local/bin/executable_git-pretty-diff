#!/usr/bin/env zsh

# Interactive git diff using fzf
# Shows git status and allows selecting files to see their diff

set -euo pipefail

if ! command -v fzf >/dev/null 2>&1; then
  echo "Error: fzf is required but not installed" >&2
  exit 1
fi

if ! git rev-parse --git-dir >/dev/null 2>&1; then
  echo "Error: not in a git repository" >&2
  exit 1
fi

# Get git status and use fzf to select files
selected_file=$(
  git -c color.status=always status --short |
  fzf --ansi \
    --preview 'git diff HEAD --color=always -- {-1} 2>/dev/null || git diff --cached --color=always -- {-1} 2>/dev/null || echo "No changes to preview"' \
    --preview-window right:65% \
    --header 'Press ENTER to copy file path to clipboard' |
  cut -c4- |
  sed 's/.* -> //'
)

# Copy selected file path to clipboard
if [[ -n "$selected_file" ]]; then
  echo "$selected_file" | tr -d '\n' | pbcopy
  echo "Copied file path to clipboard: $selected_file"
fi